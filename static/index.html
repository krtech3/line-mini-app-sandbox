<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ç®¡ç†ãƒŸãƒ‹ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * { box-sizing: border-box; }

        body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          margin: 0px;
          padding: 15px;
          background: #f0f2f5;
          color: #333;
        }

        .container {
          max-width: 600px;
          margin: auto;
          background: white;
          padding: 20px;
          border-radius: 12px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        h1 { font-size:1.5rem; margin-top: 0; text-align: center; color: #1DB446; }

        #user-info { 
          margin-bottom: 20px; 
          font-weight: 0.9rem;
          background: #e7f3ff;
          padding: 12px;
          border-radius: 8px;
          text-align: center;
          font-weight: bold;
        }

        .input-group { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            margin-bottom: 25px; 
        }

        input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            font-size: 16px; 
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            transition: opacity 0.2s;
        }

        .btn-add { background: #1DB446; color: white; }
        .btn-send { background: #007bff; color: white; margin-top: 5px; }
        .btn:active { opacity: 0.7; }

        ul { list-style: none; padding: 0; }
        li { 
            background: #fff; 
            margin-bottom: 10px; 
            padding: 15px; 
            border-radius: 10px; 
            border: 1px solid #eee;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        .product-info div:first-child { font-weight: bold; font-size: 1.1rem; }
        .product-info div:last-child { color: #888; margin-top: 4px; }

        .btn-delete {
            background: #ff4d4f;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        @media (min-width: 400px) {
            body { padding: 40px 20px; }
        }
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¦ å•†å“ç®¡ç†</h1>
        
        <div id="user-info">èª­ã¿è¾¼ã¿ä¸­...</div>

        <div class="input-group">
            <input type="text" id="name" placeholder="å•†å“åï¼ˆä¾‹ï¼šãƒãƒ§ã‚³ï¼‰">
            <input type="number" id="price" placeholder="ä¾¡æ ¼ï¼ˆä¾‹ï¼š100ï¼‰">
            <button class="btn btn-add" onclick="addProduct()">ï¼‹ ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
            <button class="btn btn-send" onclick="sendListToChat()">âœ‰ LINEã«ãƒ¬ã‚·ãƒ¼ãƒˆã‚’é€ä¿¡</button>
        </div>

        <ul id="productList"></ul>
    </div>

    <script>
      let userLineId = "";
      const MY_LIFF_ID = '2008909034-mEEj51NQ';

      async function initializeApp() {
        try {
          await liff.init({ liffId: MY_LIFF_ID });

          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }

          const profile = await liff.getProfile();
          userLineId = profile.userId;
          document.getElementById('user-info').innerText = `ã“ã‚“ã«ã¡ã¯ã€${profile.displayName} ã•ã‚“ï¼`;

          loadProducts();

        } catch (err) {
          console.error('LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', err);
          document.getElementById('user-info').innerText = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        }
      }

        async function loadProducts() {
            if (!userLineId) return;

            const response = await fetch(`/products?userId=${userLineId}`);
            const products = await response.json();
            const list = document.getElementById('productList');
            list.innerHTML = '';

            products.forEach(p => {
                const li = document.createElement('li');
                li.innerHTML = `
                  <div class="product-info">
                    <div>${p.name}</div>
                    <div>Â¥${p.price.toLocaleString()}</div>
                  </div>
                  <button class="btn-delete" onclick="deleteProduct(${p.id})">å‰Šé™¤</button>
                `;
                list.appendChild(li);
            });
        }

        async function addProduct() {
            const name = document.getElementById('name').value;
            const priceStr = document.getElementById('price').value;
            const price = parseInt(priceStr);

            if (!name || !priceStr || !userLineId) {
                alert("å…¥åŠ›ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
                return;
            }

            await fetch('/products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, price, userId: userLineId })
            });

            document.getElementById('name').value = '';
            document.getElementById('price').value = '';
            loadProducts();
        }

        async function deleteProduct(id) {
            if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const response = await fetch(`/products/${id}`, { method: 'DELETE' });
            if (response.ok) {
                loadProducts();
            } else {
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        async function sendListToChat() {
            const listItems = document.querySelectorAll('#productList li');

            if (listItems.length === 0) {
                alert('å•†å“ãƒªã‚¹ãƒˆãŒç©ºã§ã™ã€‚');
                return;
            }

            // â˜… ã“ã“ã§ itemContents ã‚’ç©ºã®é…åˆ—ã¨ã—ã¦æ­£ã—ãæº–å‚™ã—ã¾ã™
            let itemContents = [];
            let totalPrice = 0;

            listItems.forEach(item => {
                const name = item.querySelector('.product-info div:first-child').innerText;
                const priceText = item.querySelector('.product-info div:last-child').innerText;
                const priceNum = parseInt(priceText.replace(/[^0-9]/g, ''));
                totalPrice += priceNum;

                // é…åˆ—ã«ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ãƒ¼ãƒ„ã‚’è¿½åŠ 
                itemContents.push({
                    "type": "box",
                    "layout": "horizontal",
                    "contents": [
                        { "type": "text", "text": name, "size": "sm", "color": "#555555", "flex": 4 },
                        { "type": "text", "text": `Â¥${priceNum.toLocaleString()}`, "size": "sm", "color": "#111111", "align": "end", "flex": 2 }
                    ]
                });
            });

            const flexMessage = {
                "type": "flex",
                "altText": "è²·ã„ç‰©ãƒªã‚¹ãƒˆãŒå±Šãã¾ã—ãŸ",
                "contents": {
                    "type": "bubble",
                    "header": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [{ "type": "text", "text": "RECEIPT", "weight": "bold", "color": "#1DB446", "size": "sm" }]
                    },
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            { "type": "text", "text": "è²·ã„ç‰©ãƒªã‚¹ãƒˆ", "weight": "bold", "size": "xl" },
                            { "type": "separator", "margin": "md" },
                            { "type": "box", "layout": "vertical", "margin": "md", "spacing": "sm", "contents": itemContents },
                            { "type": "separator", "margin": "md" },
                            { "type": "box", "layout": "horizontal", "margin": "md", "contents": [
                                { "type": "text", "text": "åˆè¨ˆ", "size": "md", "color": "#555555", "weight": "bold" },
                                { "type": "text", "text": `Â¥${totalPrice.toLocaleString()}`, "size": "lg", "align": "end", "weight": "bold", "color": "#ff0000" }
                            ]}
                        ]
                    }
                }
            };

            try {
                if (liff.isInClient()) {
                    await liff.sendMessages([flexMessage]);
                    liff.closeWindow();
                } else {
                    alert("LINEã‚¢ãƒ—ãƒªå†…ã§åˆ©ç”¨ã—ã¦ãã ã•ã„");
                }
            } catch (err) {
                console.error(err);
                alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }

        initializeApp();
    </script>
</body>
</html>
