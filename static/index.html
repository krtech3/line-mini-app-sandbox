<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å•†å“ç®¡ç†ãƒŸãƒ‹ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body { font-family: sans-serif; margin: 40px; background: #f4f7f6; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; }

        #user-info { 
        margin-bottom: 20px; 
        font-weight: bold; 
        color: #555; 
        }

        .input-group { margin-bottom: 20px; }
        input { padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 8px 16px; background: #00b900; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #009900; }
        ul { list-style: none; padding: 0; }
        li { background: #eee; margin: 5px 0; padding: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¦ å•†å“ç®¡ç†</h1>
        
        <div id="user-info">èª­ã¿è¾¼ã¿ä¸­...</div>

        <div class="input-group">
            <input type="text" id="name" placeholder="å•†å“å">
            <input type="number" id="price" placeholder="ä¾¡æ ¼">
            <button onclick="addProduct()">è¿½åŠ </button>
            <button onclick="sendListToChat()" style="background: #007bff; margin-top: 10px; width: 100%;">LINEã«ãƒªã‚¹ãƒˆã‚’é€ä¿¡</button>
        </div>

        <ul id="productList"></ul>
    </div>

    <script>
      let userLineId = "";
      const MY_LIFF_ID = '2008909034-mEEj51NQ';

      async function initializeApp() {
        try {
          await liff.init({ liffId: MY_LIFF_ID });

          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }

          const profile = await liff.getProfile();
          userLineId = profile.userId;
          document.getElementById('user-info').innerText = `ã“ã‚“ã«ã¡ã¯ã€${profile.displayName} ã•ã‚“ï¼`;

          loadProducts();

        } catch (err) {
          console.error('LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', err);
          document.getElementById('user-info').innerText = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        }
      }

        async function loadProducts() {
            if (!userLineId) return;

            const response = await fetch(`/products?userId=${userLineId}`);
            const products = await response.json();
            const list = document.getElementById('productList');
            list.innerHTML = '';

            products.forEach(p => {
                const li = document.createElement('li');
                li.innerHTML = `
                  <div class="product-info">
                    <div style="font-weight: bold; color: #333;">${p.name}</div>
                    <div style="font-size: 0.9em; color: #666;">Â¥${p.price.toLocaleString()}</div>
                  </div>
                  <button onclick="deleteProduct(${p.id})" style="color: red; cursor: pointer; border: 1px solid red; background: white; border-radius: 4px; padding: 5px 10px;">å‰Šé™¤</button>
                `;
                list.appendChild(li);
            });
        }

        async function addProduct() {
            const name = document.getElementById('name').value;
            const priceStr = document.getElementById('price').value;
            const price = parseInt(priceStr);

            if (!name || !priceStr || !userLineId) {
                alert("å…¥åŠ›ãŒè¶³ã‚Šãªã„ã‹ã€ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“");
                return;
            }

            await fetch('/products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, price, userId: userLineId })
            });

            document.getElementById('name').value = '';
            document.getElementById('price').value = '';
            loadProducts();
        }

        async function deleteProduct(id) {
            if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            const response = await fetch(`/products/${id}`, {
                method: 'DELETE',
            });

            if (response.ok) {
                loadProducts();
            } else {
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        async function sendListToChat() {
          const listItems = document.querySelectorAll('#productList li');

          if (listItems.length === 0) {
            alert('å•†å“ãƒªã‚¹ãƒˆãŒç©ºã§ã™ã€‚');
            return;
          }

          let messageText = "ğŸ“‹ è²·ã„ç‰©ãƒªã‚¹ãƒˆ:\n";
          let totalPrice = 0;

          listItems.forEach(item => {
            const name = item.querySelector('.product-info div:first-child').innerText;
            const priceText = item.querySelector('.product-info div:last-child').innerText;
            messageText += `ãƒ»${name} (${priceText})\n`;
            totalPrice += parseInt(priceText.replace(/[^0-9]/g, ''));
          });
          
          messageText += `\nåˆè¨ˆ: Â¥${totalPrice.toLocaleString()}`;
          
          try {
            if (liff.isInClient()) {
              await liff.sendMessages([{
                type: 'text',
                text: messageText
              }]);
              alert('ãƒˆãƒ¼ã‚¯ã«é€ä¿¡ã—ã¾ã—ãŸï¼');
            } else {
              alert("LINEã‚¢ãƒ—ãƒªå†…ã§åˆ©ç”¨ã—ã¦ãã ã•ã„\n\né€ä¿¡å†…å®¹ï¼š\n" + messageText);
            }
          } catch (err) {
            console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼ï¼š', err);
            alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¨©é™è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          }
        }

        initializeApp();
    </script>
</body>
</html>
